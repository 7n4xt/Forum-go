{{define "discussion"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Discussion.Title}} - Forum</title>
    <link rel="stylesheet" href="#">

</head>

<body>
    <header class="site-header">
        <div class="container">
            <div class="site-header-content">
                <h1 class="site-title">Forum</h1>
                <nav class="site-nav">
                    <ul>
                        <li><a href="/discussions">Discussions</a></li>
                        {{if .User}}
                        <li class="user-menu">
                            <span>{{.User.Username}}</span>
                            <div class="dropdown-menu">
                                <a href="/discussions?author={{.User.UserId}}">My Discussions</a>
                                <a href="/logout">Logout</a>
                            </div>
                        </li>
                        {{else}}
                        <li><a href="/login">Login</a></li>
                        <li><a href="/signup">Sign Up</a></li>
                        {{end}}
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="breadcrumbs">
            <a href="/discussions">Discussions</a> &gt; {{.Discussion.Title}}
        </div>

        <div class="discussion-header">
            <h2>{{.Discussion.Title}}</h2>
            <div class="discussion-meta">
                <span class="discussion-author">By: {{if
                    .Discussion.Author}}{{.Discussion.Author.Username}}{{else}}Unknown{{end}}</span>
                <span class="discussion-date">{{.Discussion.CreatedAt.Format "Jan 02, 2006"}}</span>
                <span class="discussion-status {{.Discussion.Status}}">{{.Discussion.Status}}</span>
            </div>
            <div class="discussion-categories">
                {{range .Discussion.Categories}}
                <span class="category-tag">{{.}}</span>
                {{end}}
            </div>
        </div>

        <div class="discussion-description">
            <p>{{.Discussion.Description}}</p>
        </div>

        {{if and .User (or (eq .User.UserId .Discussion.AuthorId) (eq .User.Role "admin"))}}
        <div class="discussion-actions">
            <form action="/discussions/status" method="POST">
                <input type="hidden" name="discussion_id" value="{{.Discussion.DiscussionId}}">
                {{if eq .Discussion.Status "open"}}
                <button type="submit" name="status" value="closed" class="btn btn-warning">Close Discussion</button>
                <button type="submit" name="status" value="archived" class="btn btn-danger">Archive Discussion</button>
                {{else if eq .Discussion.Status "closed"}}
                <button type="submit" name="status" value="open" class="btn btn-success">Reopen Discussion</button>
                <button type="submit" name="status" value="archived" class="btn btn-danger">Archive Discussion</button>
                {{end}}
            </form>
        </div>
        {{end}}

        <div class="messages-section">
            <h3>Messages</h3>

            {{if .Messages}}
            <div class="messages-list">
                {{range .Messages}}
                <div class="message-card" id="message-{{.MessageId}}">
                    <div class="message-header">
                        <div class="message-author">
                            {{if .Author}}{{.Author.Username}}{{else}}Unknown{{end}}
                        </div>
                        <div class="message-date">{{.CreatedAt.Format "Jan 02, 2006 15:04"}}</div>
                    </div>
                    <div class="message-content">
                        <p>{{.Content}}</p>
                        {{if .HasImage}}
                        <div class="message-image">
                            <img src="{{.ImagePath}}" alt="Message attachment">
                        </div>
                        {{end}}
                    </div>
                    {{if and $.User (or (eq $.User.UserId .AuthorId) (eq $.User.Role "admin"))}}
                    <div class="message-actions">
                        <button class="btn btn-sm" onclick="toggleEditForm('{{.MessageId}}')">Edit</button>
                        <form action="/messages/delete/{{.MessageId}}" method="POST" class="inline-form">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </div>
                    <div class="message-edit-form" id="edit-form-{{.MessageId}}" style="display: none;">
                        <form action="/messages/update/{{.MessageId}}" method="POST">
                            <textarea name="content" required>{{.Content}}</textarea>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                <button type="button" class="btn btn-sm"
                                    onclick="toggleEditForm('{{.MessageId}}')">Cancel</button>
                            </div>
                        </form>
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>No messages in this discussion yet.</p>
            </div>
            {{end}}

            {{if .CanPost}}
            <div class="new-message-form">
                <h4>Post a Message</h4>
                <div style="display:none">Discussion ID: {{.Discussion.DiscussionId}}</div>
                <form action="/messages/create/{{.Discussion.DiscussionId}}" method="POST">
                    <input type="hidden" name="discussion_id" value="{{.Discussion.DiscussionId}}">
                    <div class="form-group">
                        <label for="content">Message:</label>
                        <textarea id="content" name="content" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Message</button>
                </form>
            </div>
            {{else if eq .Discussion.Status "closed"}}
            <div class="closed-message">
                <p>This discussion is closed. New messages cannot be posted.</p>
            </div>
            {{else if not .User}}
            <div class="login-prompt">
                <p>Please <a href="/login">login</a> to post messages.</p>
            </div>
            {{end}}
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2023 Forum. All rights reserved.</p>
        </div>
    </footer>

    <script>
        function toggleEditForm(messageId) {
            const form = document.getElementById(`edit-form-${messageId}`);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
</body>

</html>
{{end}}